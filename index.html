<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>条码扫描录入工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 3px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px 0;
            margin-bottom: 12px;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
        }
        
        .header h1 {
            font-size: 15px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .settings-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: #3498db;
            padding: 6px;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 固定视频框尺寸 */
        .camera-container {
            position: relative;
            width: 320px;
            height: 320px;
            background-color: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: auto;
            margin-right: auto;
        }
        
        .video-mask {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            border-radius: 6px;
        }
        
        #video {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            /* 保持原始画质，不压缩 */
            width: auto;
            height: auto;
            max-width: none;
            max-height: none;
            object-fit: contain;
        }
        
        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        /* 扫描框 - 固定大小 */
        .scan-outer-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            height: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            background-color: transparent;
            border-radius: 10px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
        }
        
        .scan-frame {
            position: relative;
            width: 260px;
            height: 260px;
            border: 2px solid #2ecc71;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            background-color: rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .scan-frame.active {
            border-color: #e74c3c;
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.5);
            animation: pulse 0.5s ease-in-out;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .scan-frame-text {
            position: absolute;
            bottom: -30px;
            width: 100%;
            text-align: center;
            color: white;
            font-size: 13px;
            font-weight: 500;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        
        .camera-info {
            text-align: center;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 12px;
            min-height: 16px;
        }
        
        .scan-instruction {
            text-align: center;
            font-size: 13px;
            color: #7f8c8d;
            margin-bottom: 15px;
            font-weight: 500;
        }
        
        /* 控制按钮区域 */
        .control-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 15px;
        }
        
        .side-btn {
            width: 55px;
            height: 55px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .side-btn:active {
            transform: scale(0.95);
        }
        
        .switch-camera-btn {
            background-color: #3498db;
            color: white;
        }
        
        .switch-camera-btn:hover {
            background-color: #2980b9;
        }
        
        .stop-camera-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        .stop-camera-btn:hover {
            background-color: #c0392b;
        }
        
        .scan-btn {
            width: 70px;
            height: 70px;
            border: none;
            border-radius: 50%;
            background-color: #2ecc71;
            color: white;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 5px 10px rgba(46, 204, 113, 0.3);
        }
        
        .scan-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 5px rgba(46, 204, 113, 0.3);
        }
        
        .scan-btn.disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .result-container {
            background-color: white;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 15px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.05);
            flex-shrink: 0;
            transition: all 0.3s ease;
        }
        
        .result-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #7f8c8d;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 0 8px;
        }
        
        .result-display {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-all;
            transition: all 0.3s ease;
        }
        
        .result-display.success {
            background-color: #d5edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .status-display {
            font-size: 12px;
            color: #7f8c8d;
            text-align: center;
            margin-top: 4px;
            padding: 0 8px;
        }
        
        .debug-info {
            font-size: 11px;
            color: #95a5a6;
            text-align: center;
            margin-top: 3px;
        }
        
        .export-container {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0;
            margin-bottom: 15px;
        }
        
        .export-btn {
            width: 100%;
            padding: 16px;
            background-color: #9b59b6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .export-btn:active {
            background-color: #8e44ad;
        }
        
        .export-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .view-data-btn {
            width: 100%;
            padding: 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 10px;
        }
        
        .view-data-btn:active {
            background-color: #2980b9;
        }
        
        .view-data-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .clear-data-btn {
            width: 100%;
            padding: 16px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        
        .clear-data-btn:active {
            background-color: #c0392b;
        }
        
        .clear-data-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .data-count {
            text-align: center;
            margin-top: 10px;
            font-size: 13px;
            color: #7f8c8d;
        }
        
        /* 弹出输入界面 - 优化后的简洁样式 */
        .input-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }
        
        .input-modal-content {
            background-color: white;
            border-radius: 12px;
            width: 100%;
            max-width: 450px;
            padding: 15px 20px 20px 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            max-height: 85vh;
            overflow-y: auto;
        }
        
        /* 移除输入模态框的标题区域 */
        .input-modal-header {
            display: none;
        }
        
        .input-modal-title {
            display: none;
        }
        
        /* 扫码结果区域 - 优化后的简洁样式 */
        .modal-scan-result {
            margin-bottom: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 12px 15px;
            border-left: 4px solid #3498db;
        }
        
        .modal-scan-result-title {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .modal-barcode-input-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .modal-barcode-label {
            font-size: 13px;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .modal-barcode-input {
            padding: 10px;
            border: 2px solid #3498db;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            outline: none;
            transition: border-color 0.3s;
            letter-spacing: 1px;
            font-family: 'Courier New', monospace;
        }
        
        .modal-barcode-input:focus {
            border-color: #e74c3c;
            box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.2);
        }
        
        .modal-barcode-hint {
            font-size: 11px;
            color: #7f8c8d;
            text-align: center;
            margin-top: 3px;
        }
        
        .quantity-input-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .quantity-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .quantity-label {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .quantity-input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .quantity-input:focus {
            border-color: #3498db;
        }
        
        .input-modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 10px;
        }
        
        .input-modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .input-modal-btn-save {
            background-color: #2ecc71;
            color: white;
        }
        
        .input-modal-btn-save:active {
            background-color: #27ae60;
        }
        
        .input-modal-btn-cancel {
            background-color: #e74c3c;
            color: white;
        }
        
        .input-modal-btn-cancel:active {
            background-color: #c0392b;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 100%;
            max-width: 450px;
            padding: 15px 20px 20px 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 22px;
            color: #7f8c8d;
            cursor: pointer;
            padding: 3px;
        }
        
        /* 查看数据模态框 */
        .data-modal-content {
            background-color: white;
            border-radius: 12px;
            width: 100%;
            max-width: 550px;
            padding: 15px 20px 20px 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .data-table-container {
            max-height: 350px;
            overflow-x: auto;
            overflow-y: auto;
            margin-bottom: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 550px;
        }
        
        .data-table th {
            background-color: #f8f9fa;
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #e0e0e0;
            position: sticky;
            top: 0;
            white-space: nowrap;
            font-size: 13px;
        }
        
        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
            font-size: 13px;
        }
        
        .data-table tr:last-child td {
            border-bottom: none;
        }
        
        .data-table tr:hover {
            background-color: #f8f9fa;
        }
        
        /* 删除按钮样式 */
        .delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .delete-btn:hover {
            background-color: #c0392b;
            transform: scale(1.1);
        }
        
        .delete-btn:active {
            transform: scale(0.95);
        }
        
        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .settings-option:last-child {
            border-bottom: none;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #3498db;
        }
        
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: #2c3e50;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            font-weight: 500;
            z-index: 1100;
            transition: transform 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            max-width: 90%;
            text-align: center;
            font-size: 14px;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
        
        /* 品番品名显示区域 */
        .product-info-container {
            margin-bottom: 15px;
            background-color: #f0f8ff;
            border-radius: 8px;
            padding: 12px;
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }
        
        .product-info-container.unknown {
            background-color: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .product-info-title {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .product-info-row {
            display: flex;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .product-info-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .product-info-label {
            font-weight: 600;
            color: #555;
            width: 60px;
            flex-shrink: 0;
            font-size: 13px;
        }
        
        .product-info-value {
            flex: 1;
            font-weight: 500;
            color: #2c3e50;
            word-break: break-all;
            font-size: 13px;
        }
        
        .product-warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* 模态框中的产品信息 */
        .modal-product-info {
            margin-bottom: 12px;
            background-color: #f0f8ff;
            border-radius: 8px;
            padding: 12px;
            border-left: 4px solid #3498db;
        }
        
        .modal-product-info.unknown {
            background-color: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .modal-product-info-title {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .modal-product-info-row {
            display: flex;
            margin-bottom: 6px;
        }
        
        .modal-product-info-label {
            font-weight: 600;
            color: #555;
            width: 50px;
            flex-shrink: 0;
            font-size: 12px;
        }
        
        .modal-product-info-value {
            flex: 1;
            font-weight: 500;
            color: #2c3e50;
            word-break: break-all;
            font-size: 12px;
        }
        
        .modal-product-warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* 设置页面中的内置数据管理区域 */
        .builtin-data-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .builtin-data-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .builtin-data-count {
            font-size: 13px;
            color: #7f8c8d;
            margin-bottom: 12px;
        }
        
        .builtin-data-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .builtin-data-btn {
            padding: 8px 12px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .builtin-data-btn:hover {
            background-color: #2980b9;
        }
        
        .builtin-data-btn.secondary {
            background-color: #7f8c8d;
        }
        
        .builtin-data-btn.secondary:hover {
            background-color: #6c7b7d;
        }
        
        /* 删除按钮样式 - 内置数据区域 */
        .clear-data-btn-red {
            background-color: #e74c3c;
        }
        
        .clear-data-btn-red:hover {
            background-color: #c0392b;
        }
        
        /* 导入内置数据模态框 */
        .import-data-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }
        
        .import-data-content {
            background-color: white;
            border-radius: 12px;
            width: 100%;
            max-width: 550px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .import-data-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 12px;
        }
        
        .import-data-textarea {
            width: 100%;
            height: 180px;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            resize: vertical;
            margin-bottom: 12px;
        }
        
        .import-data-textarea:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .import-data-format {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 12px;
            line-height: 1.4;
        }
        
        .import-data-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .import-data-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .import-data-btn.primary {
            background-color: #2ecc71;
            color: white;
        }
        
        .import-data-btn.secondary {
            background-color: #e74c3c;
            color: white;
        }
/* 数据存储警告样式 */
.storage-warning {
    background-color: #ffebee;
    border: 1px solid #ffcdd2;
    border-radius: 6px;
    padding: 8px 12px;
    margin-bottom: 12px;
    text-align: center;
}

.storage-warning p {
    font-size: 12px;
    color: #c62828;
    font-weight: 500;
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.storage-warning i {
    font-size: 14px;
}
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <h1>条码扫描录入</h1>
            <div>
                <button class="settings-btn" id="settingsBtn">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
    <!-- 数据存储提醒 -->
<div class="storage-warning">
    <p><i class="fas fa-exclamation-triangle"></i> 本Web应用的数据储存在浏览器本地，</p>
    <p>清除浏览器缓存数据将被删除，请做好备份！</p>
</div>
        
        <!-- 摄像头区域 -->
        <div class="camera-container">
            <div class="video-mask">
                <video id="video" autoplay playsinline></video>
            </div>
            <div class="video-overlay">
                <!-- 扫描框外框容器 -->
                <div class="scan-outer-container" id="scanOuterContainer">
                    <div class="scan-frame" id="scanFrame">
                        <div class="scan-frame-text">将条码放入此框内</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 摄像头信息 -->
        <div class="camera-info" id="cameraInfo">
            正在检测摄像头...
        </div>
        
        <!-- 扫描说明 -->
        <div class="scan-instruction" id="scanInstruction">
            调整条码到扫描框中，然后点击扫描按钮
        </div>
        
        <!-- 控制按钮 -->
        <div class="control-container">
            <button class="side-btn switch-camera-btn" id="switchCameraBtn" title="切换摄像头">
                <i class="fas fa-camera-retro"></i>
            </button>
            
            <button class="scan-btn" id="scanBtn" title="开始扫描">
                <i class="fas fa-barcode"></i>
            </button>
            
            <button class="side-btn stop-camera-btn" id="stopBtn" disabled title="停止摄像头">
                <i class="fas fa-stop"></i>
            </button>
        </div>
        
        <!-- 扫码结果显示 -->
        <div class="result-container">
            <div class="result-title">
                <i class="fas fa-barcode"></i> 扫码结果：
            </div>
            <div class="result-display" id="resultDisplay">
                等待扫描...
            </div>
            <div class="status-display" id="statusDisplay">
                按扫描启动摄像头...
            </div>
        </div>
        
        <!-- 产品信息显示区域 -->
        <div class="product-info-container" id="productInfoContainer" style="display: none;">
            <div class="product-info-title">
                <i class="fas fa-box-open"></i> 产品信息
            </div>
            <div class="product-info-row">
                <div class="product-info-label">品番：</div>
                <div class="product-info-value" id="productCodeValue">-</div>
            </div>
            <div class="product-info-row">
                <div class="product-info-label">品名：</div>
                <div class="product-info-value" id="productNameValue">-</div>
            </div>
            <div class="product-warning" id="productWarning" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <div>此条码不在内置数据库中，请仔细核对后保存</div>
            </div>
        </div>
        
        <!-- 数据操作按钮 -->
        <div class="export-container">
            <button class="view-data-btn" id="viewDataBtn" disabled>
                <i class="fas fa-list"></i> 查看已采集数据
            </button>
            <button class="export-btn" id="exportBtn">
                <i class="fas fa-file-excel"></i> 导出为Excel
            </button>
            <button class="clear-data-btn" id="clearDataBtn" disabled>
                <i class="fas fa-trash-alt"></i> 清空数据
            </button>
            <div class="data-count" id="dataCount">
                暂无数据
            </div>
        </div>
    </div>
    
    <!-- 输入数量模态框 -->
    <div class="input-modal" id="inputModal">
        <div class="input-modal-content">
            <!-- 移除了标题区域 -->
            
            <!-- 扫码结果区域 -->
            <div class="modal-scan-result">
                <div class="modal-scan-result-title">
                    <i class="fas fa-check-circle" style="color: #2ecc71;"></i> 扫码成功
                </div>
                <div class="modal-barcode-input-container">
                    <div class="modal-barcode-label">
                        <i class="fas fa-barcode"></i> 条码号：
                    </div>
                    <input type="text" class="modal-barcode-input" id="modalBarcodeInput" maxlength="50">
                    <div class="modal-barcode-hint">
                        可手动修改条码号
                    </div>
                </div>
            </div>
            
            <!-- 产品信息显示区域（模态框内） -->
            <div class="modal-product-info" id="modalProductInfo" style="display: none;">
                <div class="modal-product-info-title">
                    <i class="fas fa-box-open"></i> 产品信息
                </div>
                <div class="modal-product-info-row">
                    <div class="modal-product-info-label">品番：</div>
                    <div class="modal-product-info-value" id="modalProductCode">-</div>
                </div>
                <div class="modal-product-info-row">
                    <div class="modal-product-info-label">品名：</div>
                    <div class="modal-product-info-value" id="modalProductName">-</div>
                </div>
                <div class="modal-product-warning" id="modalProductWarning" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>此条码不在内置数据库中，请仔细核对后保存</div>
                </div>
            </div>
            
            <div class="quantity-input-container">
                <div class="quantity-input-group">
                    <div class="quantity-label">
                        <i class="fas fa-box"></i> 箱数：
                    </div>
                    <input type="number" class="quantity-input" id="boxQuantity" value="1" min="1" max="9999">
                </div>
                
                <div class="quantity-input-group">
                    <div class="quantity-label">
                        <i class="fas fa-cube"></i> 入数：
                    </div>
                    <input type="number" class="quantity-input" id="itemQuantity" value="1" min="1" max="9999">
                </div>
            </div>
            
            <div class="input-modal-buttons">
                <button class="input-modal-btn input-modal-btn-cancel" id="cancelInputBtn">
                    <i class="fas fa-times"></i> 取消
                </button>
                <button class="input-modal-btn input-modal-btn-save" id="saveInputBtn">
                    <i class="fas fa-save"></i> 保存
                </button>
            </div>
        </div>
    </div>
    
    <!-- 查看数据模态框 -->
    <div class="modal" id="dataModal">
        <div class="data-modal-content">
            <div class="modal-header">
                <div class="modal-title">已采集数据</div>
                <button class="close-modal" id="closeDataModal">&times;</button>
            </div>
            
            <div class="data-table-container">
                <table class="data-table" id="dataTable">
                    <thead>
                        <tr>
                            <th>序号</th>
                            <th>条码号</th>
                            <th>箱数</th>
                            <th>入数</th>
                            <th>时间</th>
                            <th>品番</th>
                            <th>品名</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <!-- 数据将在这里动态插入 -->
                    </tbody>
                </table>
            </div>
            
            <div style="text-align: center; color: #7f8c8d; font-size: 13px; margin-top: 8px;">
                共 <span id="dataCountDisplay">0</span> 条记录
            </div>
        </div>
    </div>
    
    <!-- 设置模态框 -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">扫描设置</div>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            
            <div class="settings-option">
                <div>
                    <div>扫描成功后提示音</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="soundToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="settings-option">
                <div>
                    <div>振动反馈</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="vibrationToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            
            <!-- 内置数据管理区域 -->
            <div class="builtin-data-section">
                <div class="builtin-data-title">内置数据管理</div>
                <div class="builtin-data-count" id="builtinDataCount">
                    内置数据：加载中...
                </div>
                <div class="builtin-data-actions">
                    <button class="builtin-data-btn" id="importBuiltinDataBtn">
                        <i class="fas fa-upload"></i> 导入数据
                    </button>
                    <button class="builtin-data-btn secondary" id="viewBuiltinDataBtn">
                        <i class="fas fa-eye"></i> 查看数据
                    </button>
                    <button class="builtin-data-btn secondary" id="exportBuiltinDataBtn">
                        <i class="fas fa-download"></i> 导出数据
                    </button>
                    <button class="builtin-data-btn clear-data-btn-red" id="clearBuiltinDataBtn">
                        <i class="fas fa-trash-alt"></i> 清空数据
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 15px; padding: 12px; background-color: #f8f9fa; border-radius: 6px;">
                <div style="font-weight: 600; margin-bottom: 6px; color: #2c3e50; font-size: 14px;">扫描优化提示：</div>
                <ul style="font-size: 12px; color: #7f8c8d; padding-left: 18px; margin: 0;">
                    <li>将条码放入扫描框内，确保清晰可见</li>
                    <li>保持手机稳定，距离15-20厘米</li>
                    <li>光线充足时识别效果更好</li>
                    <li>支持EAN13、UPC、Code128等格式</li>
                    <li>　　　 Kwenbin的扫码工具 © 2026</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- 导入内置数据模态框 -->
    <div class="import-data-modal" id="importDataModal">
        <div class="import-data-content">
            <div class="import-data-title">导入内置数据</div>
            <textarea class="import-data-textarea" id="importDataTextarea" placeholder="请粘贴CSV格式数据（条码,品番,品名）每行一条记录"></textarea>
            <div class="import-data-format">
                <strong>数据格式要求：</strong><br>
                1. CSV格式，每行一条记录<br>
                2. 格式：条码,品番（型号）,品名<br>
                3. 示例：1234567890123,100000001,这是示例商品名<br>
                4. 支持Excel复制的内容直接粘贴
            </div>
            <div class="import-data-buttons">
                <button class="import-data-btn secondary" id="cancelImportBtn">
                    <i class="fas fa-times"></i> 取消
                </button>
                <button class="import-data-btn primary" id="confirmImportBtn">
                    <i class="fas fa-check"></i> 导入
                </button>
            </div>
        </div>
    </div>
    
    <!-- 查看内置数据模态框 -->
    <div class="modal" id="viewBuiltinDataModal">
        <div class="data-modal-content">
            <div class="modal-header">
                <div class="modal-title">内置数据库</div>
                <button class="close-modal" id="closeBuiltinDataModal">&times;</button>
            </div>
            
            <div class="data-table-container">
                <table class="data-table" id="builtinDataTable">
                    <thead>
                        <tr>
                            <th>序号</th>
                            <th>条码</th>
                            <th>品番</th>
                            <th>品名</th>
                        </tr>
                    </thead>
                    <tbody id="builtinDataTableBody">
                        <!-- 内置数据将在这里动态插入 -->
                    </tbody>
                </table>
            </div>
            
            <div style="text-align: center; color: #7f8c8d; font-size: 13px; margin-top: 8px;">
                共 <span id="builtinDataCountDisplay">0</span> 条记录
            </div>
        </div>
    </div>
    
    <!-- 提示消息 -->
    <div class="toast" id="toast"></div>   
    <script src="xlsx.full.min.js"></script>
    <script src="quagga.min.js"></script>
    
    <script>
        // 状态变量
        let isScanning = false;
        let isProcessing = false;
        let currentBarcode = null;
        let scannedData = [];
        let soundEnabled = true;
        let vibrationEnabled = true;
        let cameraStream = null;
        let videoTrack = null;
        let currentCameraIndex = 0;
        let availableCameras = [];
        let scannerInterval = null;
        let isContinuousScanning = false;
        
        // 内置产品数据库
        let productDatabase = [
            // 示例数据
            { barcode: "1234567890123", productCode: "100000001", productName: "这是示例商品名" },
        ];
        
        // 用于快速查找的Map
        let productMap = new Map();
        
        // 初始化产品Map
        function initProductMap() {
            productMap.clear();
            productDatabase.forEach(product => {
                productMap.set(product.barcode, product);
            });
        }
        
        // DOM元素
        const video = document.getElementById('video');
        const scanBtn = document.getElementById('scanBtn');
        const stopBtn = document.getElementById('stopBtn');
        const switchCameraBtn = document.getElementById('switchCameraBtn');
        const resultDisplay = document.getElementById('resultDisplay');
        const statusDisplay = document.getElementById('statusDisplay');
        const exportBtn = document.getElementById('exportBtn');
        const viewDataBtn = document.getElementById('viewDataBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const dataCount = document.getElementById('dataCount');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeModal = document.getElementById('closeModal');
        const soundToggle = document.getElementById('soundToggle');
        const vibrationToggle = document.getElementById('vibrationToggle');
        const toast = document.getElementById('toast');
        const scanFrame = document.getElementById('scanFrame');
        const scanInstruction = document.getElementById('scanInstruction');
        const cameraInfo = document.getElementById('cameraInfo');
        
        // 输入模态框元素
        const inputModal = document.getElementById('inputModal');
        const modalBarcodeInput = document.getElementById('modalBarcodeInput');
        const boxQuantityInput = document.getElementById('boxQuantity');
        const itemQuantityInput = document.getElementById('itemQuantity');
        const saveInputBtn = document.getElementById('saveInputBtn');
        const cancelInputBtn = document.getElementById('cancelInputBtn');
        
        // 数据模态框元素
        const dataModal = document.getElementById('dataModal');
        const dataTableBody = document.getElementById('dataTableBody');
        const dataCountDisplay = document.getElementById('dataCountDisplay');
        const closeDataModal = document.getElementById('closeDataModal');
        
        // 产品信息显示元素
        const productInfoContainer = document.getElementById('productInfoContainer');
        const productCodeValue = document.getElementById('productCodeValue');
        const productNameValue = document.getElementById('productNameValue');
        const productWarning = document.getElementById('productWarning');
        
        // 模态框中的产品信息元素
        const modalProductInfo = document.getElementById('modalProductInfo');
        const modalProductCode = document.getElementById('modalProductCode');
        const modalProductName = document.getElementById('modalProductName');
        const modalProductWarning = document.getElementById('modalProductWarning');
        
        // 内置数据管理元素
        const importBuiltinDataBtn = document.getElementById('importBuiltinDataBtn');
        const viewBuiltinDataBtn = document.getElementById('viewBuiltinDataBtn');
        const exportBuiltinDataBtn = document.getElementById('exportBuiltinDataBtn');
        const clearBuiltinDataBtn = document.getElementById('clearBuiltinDataBtn');
        const builtinDataCount = document.getElementById('builtinDataCount');
        
        // 导入数据模态框元素
        const importDataModal = document.getElementById('importDataModal');
        const importDataTextarea = document.getElementById('importDataTextarea');
        const cancelImportBtn = document.getElementById('cancelImportBtn');
        const confirmImportBtn = document.getElementById('confirmImportBtn');
        
        // 查看内置数据模态框元素
        const viewBuiltinDataModal = document.getElementById('viewBuiltinDataModal');
        const builtinDataTableBody = document.getElementById('builtinDataTableBody');
        const builtinDataCountDisplay = document.getElementById('builtinDataCountDisplay');
        const closeBuiltinDataModal = document.getElementById('closeBuiltinDataModal');
        
        // 隐藏的Canvas元素
        let captureCanvas = null;
        let croppedCanvas = null;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', init);
        
        async function init() {
            // 创建隐藏的Canvas元素
            captureCanvas = document.createElement('canvas');
            croppedCanvas = document.createElement('canvas');
            
            // 初始化产品Map
            initProductMap();
            
            // 更新内置数据计数
            updateBuiltinDataCount();
            
            // 检查浏览器兼容性
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showToast('您的浏览器不支持摄像头访问', 'error');
                statusDisplay.textContent = '错误：浏览器不支持摄像头功能';
                scanBtn.disabled = true;
                switchCameraBtn.disabled = true;
                return;
            }
            
            // 事件监听器
            scanBtn.addEventListener('click', toggleScanning);
            stopBtn.addEventListener('click', stopCamera);
            switchCameraBtn.addEventListener('click', switchCamera);
            exportBtn.addEventListener('click', exportToExcel);
            viewDataBtn.addEventListener('click', showDataModal);
            clearDataBtn.addEventListener('click', clearAllData);
            settingsBtn.addEventListener('click', () => showModal(settingsModal, true));
            closeModal.addEventListener('click', () => showModal(settingsModal, false));
            closeDataModal.addEventListener('click', () => showModal(dataModal, false));
            
            // 输入模态框事件
            saveInputBtn.addEventListener('click', saveResult);
            cancelInputBtn.addEventListener('click', cancelInput);
            
            // 条码输入框监听输入事件
            modalBarcodeInput.addEventListener('input', function() {
                currentBarcode = this.value.trim();
                // 条码变化时重新检查产品信息
                checkProductInfo(currentBarcode);
            });
            
            // 内置数据管理事件
            importBuiltinDataBtn.addEventListener('click', () => showModal(importDataModal, true));
            viewBuiltinDataBtn.addEventListener('click', showBuiltinDataModal);
            exportBuiltinDataBtn.addEventListener('click', exportBuiltinData);
            clearBuiltinDataBtn.addEventListener('click', clearBuiltinData);
            cancelImportBtn.addEventListener('click', () => showModal(importDataModal, false));
            confirmImportBtn.addEventListener('click', importBuiltinData);
            closeBuiltinDataModal.addEventListener('click', () => showModal(viewBuiltinDataModal, false));
            
            // 设置切换
            soundToggle.addEventListener('change', () => {
                soundEnabled = soundToggle.checked;
                showToast(`提示音已${soundEnabled ? '开启' : '关闭'}`);
            });
            
            vibrationToggle.addEventListener('change', () => {
                vibrationEnabled = vibrationToggle.checked;
                showToast(`振动反馈已${vibrationEnabled ? '开启' : '关闭'}`);
            });
            
            // 点击模态框外部关闭
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) showModal(settingsModal, false);
            });
            
            dataModal.addEventListener('click', (e) => {
                if (e.target === dataModal) showModal(dataModal, false);
            });
            
            inputModal.addEventListener('click', (e) => {
                if (e.target === inputModal) cancelInput();
            });
            
            importDataModal.addEventListener('click', (e) => {
                if (e.target === importDataModal) showModal(importDataModal, false);
            });
            
            viewBuiltinDataModal.addEventListener('click', (e) => {
                if (e.target === viewBuiltinDataModal) showModal(viewBuiltinDataModal, false);
            });
            
            // 初始化数据
            loadDataFromStorage();
            
            // 初始启用导出按钮
            exportBtn.disabled = false;
            
            // 更新按钮状态
            updateButtonStates();
            
            // 检测可用摄像头
            await detectAvailableCameras();
            

        }
        
        // 检测可用摄像头
        async function detectAvailableCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                availableCameras = videoDevices;
                
                if (availableCameras.length === 0) {
                    cameraInfo.textContent = '未检测到摄像头';
                    switchCameraBtn.disabled = true;
                    return;
                }
                
                // 过滤掉前置摄像头
                const filteredCameras = availableCameras.filter(camera => {
                    const label = camera.label.toLowerCase();
                    return !label.includes('front') && !label.includes('前置');
                });
                
                if (filteredCameras.length === 0) {
                    // 如果没有非前置摄像头，使用第一个摄像头
                    availableCameras = videoDevices;
                } else {
                    availableCameras = filteredCameras;
                }
                
                cameraInfo.textContent = `检测到 ${availableCameras.length} 个摄像头`;
                
                // 更新切换摄像头按钮状态
                updateSwitchCameraButton();
                
                console.log('可用摄像头:', availableCameras);
            } catch (error) {
                console.error('检测摄像头失败:', error);
                cameraInfo.textContent = '检测摄像头失败';
                switchCameraBtn.disabled = true;
            }
        }
        
        // 更新切换摄像头按钮状态
        function updateSwitchCameraButton() {
            if (availableCameras.length > 1 && cameraStream) {
                // 有多个摄像头且摄像头已启动
                switchCameraBtn.disabled = false;
            } else {
                // 只有一个摄像头或摄像头未启动
                switchCameraBtn.disabled = true;
            }
        }
        
        // 切换摄像头
        async function switchCamera() {
            if (availableCameras.length < 2) {
                showToast('只有一个摄像头可用', 'info');
                return;
            }
            
            // 停止当前扫描
            if (isContinuousScanning) {
                stopContinuousScanning();
            }
            
            // 切换到下一个摄像头
            currentCameraIndex = (currentCameraIndex + 1) % availableCameras.length;
            
            // 重新启动摄像头
            await startCameraPreview();
            
            const cameraLabel = availableCameras[currentCameraIndex].label || '摄像头';
            const cameraName = cameraLabel.length > 20 ? cameraLabel.substring(0, 20) + '...' : cameraLabel;
            cameraInfo.textContent = `检测到 ${availableCameras.length} 个摄像头，已切换为：${cameraName}`;
            
            showToast(`已切换到 ${cameraName}`, 'success');
        }
        
        // 启动摄像头预览
        async function startCameraPreview() {
            try {
                showToast('正在启动摄像头...');
                statusDisplay.textContent = '正在启动摄像头...';
                scanBtn.disabled = true;
                stopBtn.disabled = false;
                
                // 先停止之前的流
                if (cameraStream) {
                    stopAllTracks(cameraStream);
                }
                
                // 获取摄像头权限 - 使用最简单约束，让浏览器自动选择最佳设置
                const constraints = {
                    video: { 
                        deviceId: availableCameras[currentCameraIndex]?.deviceId ? 
                            { exact: availableCameras[currentCameraIndex].deviceId } : undefined
                    } 
                };
                
                // 如果设备ID未指定，使用环境模式（后置摄像头）
                if (!constraints.video.deviceId) {
                    constraints.video.facingMode = 'environment';
                }
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // 检查是否有视频轨道
                videoTrack = cameraStream.getVideoTracks()[0];
                if (!videoTrack) {
                    throw new Error('未找到视频轨道');
                }
                
                // 获取摄像头实际设置
                const settings = videoTrack.getSettings();
                console.log("摄像头设置:", settings);
                
                const cameraLabel = availableCameras[currentCameraIndex]?.label || '摄像头';
                const cameraName = cameraLabel.length > 20 ? cameraLabel.substring(0, 20) + '...' : cameraLabel;
                cameraInfo.textContent = `检测到 ${availableCameras.length} 个摄像头，已切换为：${cameraName}`;
                
                video.srcObject = cameraStream;
                
                // 等待视频元数据加载
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play().then(resolve).catch(resolve);
                    };
                    setTimeout(resolve, 1000);
                });
                
                // 启用扫描按钮
                scanBtn.disabled = false;
                scanBtn.classList.remove('disabled');
                statusDisplay.textContent = '摄像头已就绪，请将条码放入扫描框中';
                scanInstruction.textContent = '调整条码到扫描框中，然后点击扫描按钮';
                
                // 更新切换摄像头按钮状态
                updateSwitchCameraButton();
                
                showToast('摄像头已启动', 'success');
                
            } catch (err) {
                console.error('摄像头启动失败:', err);
                let errorMessage = '摄像头启动失败';
                
                if (err.name === 'NotAllowedError') {
                    errorMessage = '请允许摄像头访问权限';
                } else if (err.name === 'NotFoundError') {
                    errorMessage = '未找到摄像头设备';
                } else if (err.name === 'NotReadableError') {
                    errorMessage = '摄像头正被其他应用占用';
                } else if (err.name === 'OverconstrainedError') {
                    errorMessage = '无法满足摄像头参数要求';
                } else {
                    errorMessage = `摄像头启动失败: ${err.message}`;
                }
                
                showToast(errorMessage, 'error');
                statusDisplay.textContent = errorMessage;
                scanBtn.disabled = false;
                scanBtn.classList.remove('disabled');
                stopBtn.disabled = true;
                switchCameraBtn.disabled = true;
            }
        }
        
        // 停止摄像头
        function stopCamera() {
            // 停止连续扫描
            if (isContinuousScanning) {
                stopContinuousScanning();
            }
            
            if (cameraStream) {
                stopAllTracks(cameraStream);
                cameraStream = null;
                video.srcObject = null;
                
                scanBtn.disabled = false;
                scanBtn.classList.remove('disabled');
                scanBtn.innerHTML = '<i class="fas fa-barcode"></i>';
                stopBtn.disabled = true;
                
                // 停止摄像头后禁用切换摄像头按钮
                switchCameraBtn.disabled = true;
                
                statusDisplay.textContent = '摄像头已关闭';
                scanInstruction.textContent = '请点击启动摄像头重新开始';
                cameraInfo.textContent = '摄像头已关闭';
                
                showToast('摄像头已关闭');
            }
        }
        
        // 切换扫描状态
        function toggleScanning() {
            if (!cameraStream) {
                // 如果摄像头未启动，先启动摄像头
                startCameraPreview().then(() => {
                    // 摄像头启动后开始扫描
                    startContinuousScanning();
                });
                return;
            }
            
            if (isContinuousScanning) {
                stopContinuousScanning();
            } else {
                startContinuousScanning();
            }
        }
        
        // 开始连续扫描
        function startContinuousScanning() {
            if (isProcessing) {
                showToast('正在处理中，请稍候...', 'info');
                return;
            }
            
            if (!cameraStream) {
                showToast('请先启动摄像头', 'error');
                return;
            }
            
            isContinuousScanning = true;
            scanBtn.innerHTML = '<i class="fas fa-pause"></i>';
            scanFrame.classList.add('active');
            statusDisplay.textContent = '正在连续扫描中...';
            
            showToast('开始连续扫描', 'success');
            
            // 开始连续扫描
            scannerInterval = setInterval(async () => {
                if (!isProcessing) {
                    await performSingleScan();
                }
            }, 500); // 每500ms扫描一次
        }
        
        // 停止连续扫描
        function stopContinuousScanning() {
            isContinuousScanning = false;
            if (scannerInterval) {
                clearInterval(scannerInterval);
                scannerInterval = null;
            }
            
            scanBtn.innerHTML = '<i class="fas fa-barcode"></i>';
            scanFrame.classList.remove('active');
            statusDisplay.textContent = '连续扫描已停止';
            
            showToast('连续扫描已停止');
        }
        
        // 执行单次扫描
        async function performSingleScan() {
            if (isProcessing) return;
            
            isProcessing = true;
            
            try {
                // 截取当前视频帧
                const imageData = await captureScanArea();
                
                // 使用QuaggaJS解码条码
                const barcode = await decodeBarcodeFromImage(imageData);
                
                if (barcode) {
                    // 识别成功
                    handleSuccessfulScan(barcode);
                }
            } catch (error) {
                console.error('扫描过程中出错:', error);
            } finally {
                isProcessing = false;
            }
        }
        
        // 截取扫描区域并进行图像增强
        async function captureScanArea() {
            return new Promise((resolve, reject) => {
                try {
                    // 确保视频已准备就绪
                    if (video.readyState < 2) {
                        reject(new Error('视频未准备就绪'));
                        return;
                    }
                    
                    // 设置Canvas尺寸与视频实际尺寸相同
                    captureCanvas.width = video.videoWidth;
                    captureCanvas.height = video.videoHeight;
                    const ctx = captureCanvas.getContext('2d');
                    
                    // 绘制整个视频帧
                    ctx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
                    
                    // 计算扫描框在视频帧中的精确位置
                    const scanBox = document.getElementById('scanFrame');
                    const videoRect = video.getBoundingClientRect();
                    const scanRect = scanBox.getBoundingClientRect();
                    
                    // 计算缩放比例
                    const scaleX = video.videoWidth / videoRect.width;
                    const scaleY = video.videoHeight / videoRect.height;
                    
                    // 计算扫描框在视频帧中的位置和大小
                    const cropX = Math.max(0, (scanRect.left - videoRect.left) * scaleX);
                    const cropY = Math.max(0, (scanRect.top - videoRect.top) * scaleY);
                    const cropWidth = Math.min(scanRect.width * scaleX, video.videoWidth - cropX);
                    const cropHeight = Math.min(scanRect.height * scaleY, video.videoHeight - cropY);
                    
                    // 确保截取区域有效
                    if (cropWidth <= 0 || cropHeight <= 0) {
                        reject(new Error('扫描框区域无效'));
                        return;
                    }
                    
                    // 创建截取的图像
                    croppedCanvas.width = cropWidth;
                    croppedCanvas.height = cropHeight;
                    const croppedCtx = croppedCanvas.getContext('2d');
                    
                    // 绘制扫描框区域
                    croppedCtx.drawImage(
                        captureCanvas, 
                        cropX, cropY, cropWidth, cropHeight,
                        0, 0, cropWidth, cropHeight
                    );
                    
                    // 转换为DataURL
                    const imageData = croppedCanvas.toDataURL('image/jpeg', 1.0);
                    resolve(imageData);
                    
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // 从图像解码条码
        function decodeBarcodeFromImage(imageData) {
            return new Promise((resolve) => {
                // 使用QuaggaJS直接解码图像
                Quagga.decodeSingle({
                    src: imageData,
                    numOfWorkers: 0,
                    decoder: {
                        readers: [
                            "ean_reader",           // EAN-13
                            "ean_8_reader",        // EAN-8
                            "upc_reader",          // UPC-A
                            "upc_e_reader",        // UPC-E
                            "code_128_reader",     // Code 128
                            "code_39_reader",      // Code 39
                            "codabar_reader"       // Codabar
                        ]
                    },
                    locate: true,
                    inputStream: {
                        size: 800  // 适当限制大小以提高速度
                    },
                    debug: {
                        drawBoundingBox: false,
                        showFrequency: false,
                        drawScanline: false,
                        showPattern: false
                    }
                }, function(result) {
                    if (result && result.codeResult) {
                        const code = result.codeResult.code;
                        const format = result.codeResult.format;
                        console.log("解码成功:", code, "格式:", format);
                        
                        // 验证是否为EAN13/JAN13格式 (13位数字)
                        if (/^\d{13}$/.test(code)) {
                            resolve(code);
                        } else if (/^\d{12}$/.test(code)) {
                            // UPC-A是12位，可以转换为EAN-13
                            const ean13 = '0' + code;
                            resolve(ean13);
                        } else {
                            // 其他格式也接受
                            resolve(code);
                        }
                    } else {
                        resolve(null);
                    }
                });
            });
        }
        
        // 处理成功扫描的函数
        function handleSuccessfulScan(barcode) {
            // 停止连续扫描以处理结果
            if (isContinuousScanning) {
                stopContinuousScanning();
            }
            
            currentBarcode = barcode;
            
            // 更新页面上的结果显示
            resultDisplay.textContent = barcode;
            resultDisplay.classList.add('success');
            
            // 在模态框输入框中设置条码号
            modalBarcodeInput.value = barcode;
            
            // 检查产品信息
            checkProductInfo(barcode);
            
            // 触发反馈
            if (soundEnabled) {
                playBeepSound();
            }
            
            if (vibrationEnabled && 'vibrate' in navigator) {
                navigator.vibrate([100, 50, 100]);
            }
            
            // 显示输入模态框
            showModal(inputModal, true);
            
            // 聚焦到条码号输入框并选中文本，方便修改
            setTimeout(() => {
                modalBarcodeInput.focus();
                modalBarcodeInput.select();
            }, 100);
            
            showToast(`条码扫描成功: ${barcode}`, 'success');
        }
        
        // 检查产品信息
        function checkProductInfo(barcode) {
            const product = productMap.get(barcode);
            
            // 更新页面上的产品信息显示
            if (product) {
                // 找到产品
                productInfoContainer.style.display = 'block';
                productInfoContainer.classList.remove('unknown');
                productCodeValue.textContent = product.productCode;
                productNameValue.textContent = product.productName;
                productWarning.style.display = 'none';
                
                // 更新模态框中的产品信息
                modalProductInfo.style.display = 'block';
                modalProductInfo.classList.remove('unknown');
                modalProductCode.textContent = product.productCode;
                modalProductName.textContent = product.productName;
                modalProductWarning.style.display = 'none';
                
                statusDisplay.textContent = '条码扫描成功！产品信息已匹配';
            } else {
                // 未找到产品
                productInfoContainer.style.display = 'block';
                productInfoContainer.classList.add('unknown');
                productCodeValue.textContent = '-';
                productNameValue.textContent = '-';
                productWarning.style.display = 'flex';
                
                // 更新模态框中的产品信息
                modalProductInfo.style.display = 'block';
                modalProductInfo.classList.add('unknown');
                modalProductCode.textContent = '-';
                modalProductName.textContent = '-';
                modalProductWarning.style.display = 'flex';
                
                statusDisplay.textContent = '条码扫描成功！此条码不在数据库中，请核对';
            }
        }
        
        // 更新内置数据计数
        function updateBuiltinDataCount() {
            const count = productDatabase.length;
            builtinDataCount.textContent = `内置数据：${count} 条记录`;
        }
        
        // 显示内置数据模态框
        function showBuiltinDataModal() {
            // 清空表格
            builtinDataTableBody.innerHTML = '';
            
            // 添加数据行
            productDatabase.forEach((product, index) => {
                const row = document.createElement('tr');
                
                // 序号
                const indexCell = document.createElement('td');
                indexCell.textContent = index + 1;
                row.appendChild(indexCell);
                
                // 条码
                const barcodeCell = document.createElement('td');
                barcodeCell.textContent = product.barcode;
                barcodeCell.style.whiteSpace = 'nowrap';
                barcodeCell.style.overflow = 'hidden';
                barcodeCell.style.textOverflow = 'ellipsis';
                row.appendChild(barcodeCell);
                
                // 品番
                const codeCell = document.createElement('td');
                codeCell.textContent = product.productCode;
                codeCell.style.whiteSpace = 'nowrap';
                row.appendChild(codeCell);
                
                // 品名
                const nameCell = document.createElement('td');
                nameCell.textContent = product.productName;
                nameCell.style.whiteSpace = 'nowrap';
                nameCell.style.overflow = 'hidden';
                nameCell.style.textOverflow = 'ellipsis';
                row.appendChild(nameCell);
                
                builtinDataTableBody.appendChild(row);
            });
            
            // 更新数据计数显示
            builtinDataCountDisplay.textContent = productDatabase.length;
            
            // 显示模态框
            showModal(viewBuiltinDataModal, true);
        }
        
        // 清空内置数据
        function clearBuiltinData() {
            if (productDatabase.length === 0) {
                showToast('暂无内置数据可以清空', 'info');
                return;
            }
            
            if (confirm(`确定要清空所有 ${productDatabase.length} 条内置数据吗？此操作不可撤销。`)) {
                productDatabase = [];
                initProductMap();
                saveBuiltinDataToStorage();
                updateBuiltinDataCount();
                showToast('内置数据已清空', 'success');
            }
        }
        
        // 导入内置数据
        function importBuiltinData() {
            const text = importDataTextarea.value.trim();
            
            if (!text) {
                showToast('请输入要导入的数据', 'error');
                return;
            }
            
            try {
                const lines = text.split('\n');
                const newProducts = [];
                
                for (let line of lines) {
                    line = line.trim();
                    if (!line) continue;
                    
                    // 处理CSV格式：条码,品番,品名
                    const parts = line.split(',').map(part => part.trim());
                    
                    if (parts.length >= 3) {
                        const barcode = parts[0];
                        const productCode = parts[1];
                        const productName = parts.slice(2).join(','); // 处理品名中可能包含逗号的情况
                        
                        if (barcode && productCode && productName) {
                            newProducts.push({
                                barcode: barcode,
                                productCode: productCode,
                                productName: productName
                            });
                        }
                    }
                }
                
                if (newProducts.length === 0) {
                    showToast('未找到有效的数据记录', 'error');
                    return;
                }
                
                // 添加到现有数据库（避免重复）
                const existingBarcodes = new Set(productDatabase.map(p => p.barcode));
                
                let addedCount = 0;
                let updatedCount = 0;
                
                for (const newProduct of newProducts) {
                    if (existingBarcodes.has(newProduct.barcode)) {
                        // 更新现有记录
                        const index = productDatabase.findIndex(p => p.barcode === newProduct.barcode);
                        if (index !== -1) {
                            productDatabase[index] = newProduct;
                            updatedCount++;
                        }
                    } else {
                        // 添加新记录
                        productDatabase.push(newProduct);
                        addedCount++;
                    }
                }
                
                // 重新初始化产品Map
                initProductMap();
                
                // 更新显示
                updateBuiltinDataCount();
                
                // 保存到本地存储
                saveBuiltinDataToStorage();
                
                // 清空文本区域
                importDataTextarea.value = '';
                
                // 关闭模态框
                showModal(importDataModal, false);
                
                showToast(`导入成功：新增 ${addedCount} 条，更新 ${updatedCount} 条`, 'success');
                
            } catch (error) {
                console.error('导入数据失败:', error);
                showToast('导入数据失败，请检查数据格式', 'error');
            }
        }
        
        // 导出内置数据
        function exportBuiltinData() {
            if (productDatabase.length === 0) {
                showToast('暂无内置数据可导出', 'error');
                return;
            }
            
            try {
                // 创建工作簿
                const wb = XLSX.utils.book_new();
                
                // 创建工作表数据
                const wsData = [
                    ["条码", "品番", "品名"],
                ];
                
                // 添加数据行
                productDatabase.forEach(product => {
                    wsData.push([product.barcode, product.productCode, product.productName]);
                });
                
                // 创建工作表
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // 设置列宽
                const wscols = [
                    { wch: 15 },
                    { wch: 12 },
                    { wch: 30 }
                ];
                ws['!cols'] = wscols;
                
                // 将工作表添加到工作簿
                XLSX.utils.book_append_sheet(wb, ws, "内置产品数据");
                
                // 生成Excel文件并下载
                const fileName = `内置产品数据_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showToast(`已导出 ${productDatabase.length} 条内置数据`, 'success');
            } catch (error) {
                console.error('导出内置数据失败:', error);
                showToast('导出内置数据失败，请重试', 'error');
            }
        }
        
        // 保存内置数据到本地存储
        function saveBuiltinDataToStorage() {
            try {
                localStorage.setItem('productDatabase', JSON.stringify(productDatabase));
            } catch (e) {
                console.error('保存内置数据失败:', e);
            }
        }
        
        // 从本地存储加载内置数据
        function loadBuiltinDataFromStorage() {
            try {
                const savedData = localStorage.getItem('productDatabase');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    if (Array.isArray(parsedData)) {
                        productDatabase = parsedData;
                    }
                }
            } catch (e) {
                console.error('加载内置数据失败:', e);
            }
        }
        
        // 停止所有视频轨道
        function stopAllTracks(stream) {
            stream.getTracks().forEach(track => {
                track.stop();
            });
        }
        
        // 保存结果
        function saveResult() {
            // 从输入框获取条码号（可能被用户修改过）
            const barcode = modalBarcodeInput.value.trim();
            
            if (!barcode) {
                showToast('条码号不能为空', 'error');
                modalBarcodeInput.focus();
                return;
            }
            
            const boxQuantity = parseInt(boxQuantityInput.value);
            const itemQuantity = parseInt(itemQuantityInput.value);
            
            if (isNaN(boxQuantity) || boxQuantity < 1 || isNaN(itemQuantity) || itemQuantity < 1) {
                showToast('请输入有效的数量', 'error');
                return;
            }
            
            // 检查条码是否在内置数据库中
            const product = productMap.get(barcode);
            
            // 如果不在数据库中，提示用户确认
            if (!product) {
                if (!confirm('⚠️ 警告：此条码不在内置数据库中\n\n条码: ' + barcode + '\n\n是否确认保存？')) {
                    return;
                }
            }
            
            // 添加新记录
            scannedData.push({
                barcode: barcode,
                boxQuantity: boxQuantity,
                itemQuantity: itemQuantity,
                timestamp: new Date().toLocaleString(),
                productCode: product ? product.productCode : '',
                productName: product ? product.productName : ''
            });
            
            showToast(`已保存: ${barcode} 箱数: ${boxQuantity} 入数: ${itemQuantity}`, 'success');
            
            // 保存到本地存储
            saveDataToStorage();
            
            // 重置界面
            currentBarcode = null;
            modalBarcodeInput.value = '';
            resultDisplay.textContent = '等待扫描...';
            resultDisplay.classList.remove('success');
            statusDisplay.textContent = '保存成功！请继续扫描下一项';
            
            // 隐藏产品信息区域
            productInfoContainer.style.display = 'none';
            modalProductInfo.style.display = 'none';
            
            // 关闭输入模态框
            showModal(inputModal, false);
            
            // 更新数据计数
            updateDataCount();
            
            // 更新按钮状态
            updateButtonStates();
            
            // 如果是连续扫描模式，重新启动扫描
            if (isContinuousScanning) {
                setTimeout(() => {
                    startContinuousScanning();
                }, 1000);
            }
        }
        
        // 取消输入
        function cancelInput() {
            // 重置界面
            currentBarcode = null;
            modalBarcodeInput.value = '';
            resultDisplay.textContent = '等待扫描...';
            resultDisplay.classList.remove('success');
            
            // 隐藏产品信息区域
            productInfoContainer.style.display = 'none';
            modalProductInfo.style.display = 'none';
            
            // 关闭输入模态框
            showModal(inputModal, false);
            
            showToast('已取消输入');
            
            // 如果是连续扫描模式，重新启动扫描
            if (isContinuousScanning) {
                setTimeout(() => {
                    startContinuousScanning();
                }, 500);
            }
        }
        
        // 导出为Excel
        function exportToExcel() {
            if (scannedData.length === 0) {
                showToast('暂无数据可导出', 'error');
                return;
            }
            
            try {
                // 创建工作簿
                const wb = XLSX.utils.book_new();
                
                // 创建工作表数据
                const wsData = [
                    ["条码号", "品番", "品名", "箱数", "入数", "时间"],
                ];
                
                // 添加数据行
                scannedData.forEach(item => {
                    wsData.push([
                        item.barcode, 
                        item.productCode || '',
                        item.productName || '',
                        item.boxQuantity, 
                        item.itemQuantity, 
                        item.timestamp
                    ]);
                });
                
                // 创建工作表
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // 设置列宽
                const wscols = [
                    { wch: 15 },
                    { wch: 12 },
                    { wch: 30 },
                    { wch: 8 },
                    { wch: 8 },
                    { wch: 20 }
                ];
                ws['!cols'] = wscols;
                
                // 将工作表添加到工作簿
                XLSX.utils.book_append_sheet(wb, ws, "条码数据");
                
                // 生成Excel文件并下载
                const fileName = `条码数据_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showToast(`已导出 ${scannedData.length} 条数据`, 'success');
            } catch (error) {
                console.error('导出Excel失败:', error);
                showToast('导出Excel失败，请重试', 'error');
            }
        }
        
        // 清空所有数据
        function clearAllData() {
            if (scannedData.length === 0) {
                showToast('没有数据可以清空', 'info');
                return;
            }
            
            if (confirm(`确定要清空所有 ${scannedData.length} 条数据吗？此操作不可撤销。`)) {
                scannedData = [];
                saveDataToStorage();
                updateDataCount();
                updateButtonStates();
                exportBtn.disabled = false;
                showToast('所有数据已清空', 'success');
            }
        }
        
        // 删除单条数据
        function deleteDataItem(index) {
            if (index >= 0 && index < scannedData.length) {
                const item = scannedData[index];
                if (confirm(`确定要删除条码 ${item.barcode} 的记录吗？`)) {
                    scannedData.splice(index, 1);
                    saveDataToStorage();
                    updateDataCount();
                    updateButtonStates();
                    // 如果数据表格正在显示，更新它
                    if (dataModal.style.display === 'flex') {
                        updateDataTable();
                    }
                    showToast('记录已删除', 'success');
                }
            }
        }
        
        // 更新按钮状态
        function updateButtonStates() {
            const hasData = scannedData.length > 0;
            viewDataBtn.disabled = !hasData;
            clearDataBtn.disabled = !hasData;
        }
        
        // 显示数据模态框
        function showDataModal() {
            if (scannedData.length === 0) {
                showToast('暂无数据可查看', 'info');
                return;
            }
            
            // 更新表格数据
            updateDataTable();
            
            // 显示模态框
            showModal(dataModal, true);
        }
        
        // 更新数据表格
        function updateDataTable() {
            // 清空表格
            dataTableBody.innerHTML = '';
            
            // 添加数据行
            scannedData.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // 序号
                const indexCell = document.createElement('td');
                indexCell.textContent = index + 1;
                row.appendChild(indexCell);
                
                // 条码号
                const barcodeCell = document.createElement('td');
                barcodeCell.textContent = item.barcode;
                barcodeCell.style.whiteSpace = 'nowrap';
                barcodeCell.style.overflow = 'hidden';
                barcodeCell.style.textOverflow = 'ellipsis';
                row.appendChild(barcodeCell);
                
                // 箱数
                const boxCell = document.createElement('td');
                boxCell.textContent = item.boxQuantity;
                boxCell.style.whiteSpace = 'nowrap';
                row.appendChild(boxCell);
                
                // 入数
                const itemCell = document.createElement('td');
                itemCell.textContent = item.itemQuantity;
                itemCell.style.whiteSpace = 'nowrap';
                row.appendChild(itemCell);
                
                // 时间
                const timeCell = document.createElement('td');
                timeCell.textContent = item.timestamp;
                timeCell.style.whiteSpace = 'nowrap';
                row.appendChild(timeCell);
                
                // 品番
                const productCodeCell = document.createElement('td');
                productCodeCell.textContent = item.productCode || '-';
                productCodeCell.style.whiteSpace = 'nowrap';
                row.appendChild(productCodeCell);
                
                // 品名
                const productNameCell = document.createElement('td');
                productNameCell.textContent = item.productName || '-';
                productNameCell.style.whiteSpace = 'nowrap';
                productNameCell.style.overflow = 'hidden';
                productNameCell.style.textOverflow = 'ellipsis';
                row.appendChild(productNameCell);
                
                // 操作列 - 删除按钮
                const actionCell = document.createElement('td');
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                deleteBtn.title = '删除此条记录';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation(); // 防止事件冒泡
                    deleteDataItem(index);
                };
                actionCell.appendChild(deleteBtn);
                actionCell.style.whiteSpace = 'nowrap';
                row.appendChild(actionCell);
                
                dataTableBody.appendChild(row);
            });
            
            // 更新数据计数显示
            dataCountDisplay.textContent = scannedData.length;
        }
        
        // 显示/隐藏模态框
        function showModal(modal, show) {
            modal.style.display = show ? 'flex' : 'none';
            
            // 如果显示模态框，阻止body滚动
            if (show) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = 'auto';
            }
        }
        
        // 显示提示消息
        function showToast(message, type = 'info') {
            toast.textContent = message;
            
            // 根据类型设置背景色
            if (type === 'error') {
                toast.style.backgroundColor = '#e74c3c';
            } else if (type === 'success') {
                toast.style.backgroundColor = '#2ecc71';
            } else {
                toast.style.backgroundColor = '#2c3e50';
            }
            
            toast.classList.add('show');
            
            // 3秒后隐藏
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // 播放提示音
        function playBeepSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 1200;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                console.log('音频播放失败:', e);
            }
        }
        
        // 保存数据到本地存储
        function saveDataToStorage() {
            try {
                localStorage.setItem('scannedBarcodeData', JSON.stringify(scannedData));
            } catch (e) {
                console.error('保存数据失败:', e);
            }
        }
        
        // 从本地存储加载数据
        function loadDataFromStorage() {
            try {
                const savedData = localStorage.getItem('scannedBarcodeData');
                if (savedData) {
                    scannedData = JSON.parse(savedData);
                    updateDataCount();
                    updateButtonStates();
                    
                    if (scannedData.length > 0) {
                        exportBtn.disabled = false;
                    }
                }
            } catch (e) {
                console.error('加载数据失败:', e);
                scannedData = [];
            }
        }
        
        // 更新数据计数显示
        function updateDataCount() {
            const count = scannedData.length;
            dataCount.textContent = count > 0 ? `已保存 ${count} 条数据` : '暂无数据';
        }
        
        // 监听键盘事件
        document.addEventListener('keydown', (e) => {
            // 如果输入模态框显示，处理输入
            if (inputModal.style.display === 'flex') {
                // 按Enter键保存
                if (e.key === 'Enter' && !e.shiftKey) {
                    // 如果当前焦点在条码输入框，切换到箱数输入框
                    if (document.activeElement === modalBarcodeInput) {
                        e.preventDefault();
                        boxQuantityInput.focus();
                        boxQuantityInput.select();
                    }
                    // 如果当前焦点在箱数输入框，切换到入数输入框
                    else if (document.activeElement === boxQuantityInput) {
                        e.preventDefault();
                        itemQuantityInput.focus();
                        itemQuantityInput.select();
                    }
                    // 如果当前焦点在入数输入框，则保存
                    else if (document.activeElement === itemQuantityInput) {
                        e.preventDefault();
                        saveResult();
                    }
                    // 其他情况保存
                    else {
                        saveResult();
                    }
                }
                
                // 按ESC键取消
                else if (e.key === 'Escape') {
                    cancelInput();
                }
                
                // 阻止默认行为，避免影响输入
                return;
            }
            
            // 按空格键触发扫描
            if (e.key === ' ' && !isProcessing && cameraStream) {
                e.preventDefault();
                if (!isContinuousScanning) {
                    toggleScanning();
                }
            }
            
            // 按ESC键关闭摄像头
            if (e.key === 'Escape' && cameraStream) {
                stopCamera();
            }
        });
        
        // 页面加载时加载内置数据
        window.addEventListener('load', function() {
            // 从本地存储加载内置数据
            loadBuiltinDataFromStorage();
            // 重新初始化产品Map
            initProductMap();
            // 更新内置数据计数
            updateBuiltinDataCount();
        });
    </script>
</body>
</html>